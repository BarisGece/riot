= {app-name}
:app-name: RIOT Redis
:app: riot-redis
include::../docs/preamble.adoc[]

== Overview

Most database migration tools available today are offline in nature. Migrating data from AWS ElastiCache to Redis Enterprise Cloud for example means backing up your Elasticache data to an AWS S3 bucket and importing it into Redis Enterprise Cloud using its UI.

{app-name} is a migration tool that allows for live data migration between any Redis databases:

[source,bash]
----
riot-redis -h source -p 6379 replicate -h target -p 6380 --mode live
----

{app-name} does not make use of the https://redis.io/commands/replicaof[REPLICAOF] command which is not always available (e.g. ElastiCache), but instead implements client-side replication using DUMP and RESTORE:

image::replication.png[]

1. Key reader: initiates a SCAN and optionally calls SUBSCRIBE to listen for keyspace notifications (live replication).
2. Value reader: takes the keys and calls DUMP and TTL.
3. Key/Value writer: takes key/value/ttl tuples and calls RESTORE and EXPIRE.

include::../docs/getting_started.adoc[]

== Replicating

The replication process takes data from a source Redis database and replicates it into a target Redis database.

The general usage is:

[source,bash]
----
riot-redis -h <src host> -p <src port> replicate -h <dest host> -p <dest port> ...
----

For the `replicate` command usage help, run:

[subs="attributes",source,bash]
----
{app} replicate --help
----

=== Verification

Once replication is complete (i.e. for snapshot replication when scan is complete, for live replication when no keyspace notification idle) *{app-name}* will perform a verification step to compare values and TTLs between source and target databases. The output looks like this:

----
OK:1000 V:0 >:0 <:0 T:0
----

* `OK`: # identical values
* `V`: # mismatched values
* `>`: # keys only present in source database
* `<`: # keys only present in target database
* `T`: # keys with TTL difference greater than tolerance

== Architecture

{app-name} follows a producer/consumer approach.

=== Producer

The producer is connected to the source Redis (e.g. ElastiCache) database and iterates over keys to be replicated by performing a SCAN and reading the corresponding values with DUMP. This is the snapshot part of the replication process.

If live replication is enabled the producer also subscribes to keyspace notifications to generate a continuous stream of keys and corresponding values.

TIP: Make sure the source Redis database has keyspace notifications enabled using `notify-keyspace-events = KA` in `redis.conf` or via CONFIG SET.

WARNING: The live replication mechanism does not guarantee data consistency. Redis sends keyspace notifications over pub/sub which does not provide	guaranteed delivery. It is possible that {app-name} can miss some notifications in case of network failures for example.


Both snapshot and live producer processes make use of https://redis.io/topics/pipelining[pipelining] in order to read values in a batch fashion. Use the `--reader-batch` option to configure the number of values to be read in a single pipelined call. Each process can be multi-threaded using the `--reader-threads` option.

=== Consumer

The consumer is responsible for ingesting the keys and values generated by the producer and writing them to the target Redis database (e.g. Redis Enterprise Cloud). For each key/value pair it issues a RESTORE command.

The consumer process also makes use of https://redis.io/topics/pipelining[pipelining] in order to write values in a batch fashion. Use the `--batch` option to configure the number of values to be written in a single pipelined call.

Like the consumer the producer process can be multi-threaded, using the `--threads` option.

=== Type-Based Replication

With {app-name} 2.8.0 another replication mechanism was introduced that uses data structure-specific producers and consumers.

[source,bash]
----
riot-redis -h source -p 6379 replicate-ds -h target -p 6380 --mode live
----

For each Redis data type there is a corresponding pair of read/write commands:

[options="header",cols=",m,m",frame="none",grid="none"]
|=========================================================
|Type|Read|Write

|Hash|HGETALL|HSET
|List|LRANGE|RPUSH
|Set|SMEMBERS|SADD
|Sorted Set|ZRANGE|ZADD
|Stream|XRANGE|XADD
|String|GET|SET

|=========================================================

WARNING: This replication strategy is more intensive in terms of CPU, memory, and network for the machines running {app-name}. Adjust number of threads, batch, and queue sizes accordingly.

