plugins {
    id 'org.asciidoctor.jvm.convert'
    id 'org.ajoberstar.git-publish' version '3.0.0'
    id 'com.github.ben-manes.versions' version '0.38.0'
    id 'org.jreleaser' version '0.2.0'
}

repositories {
    mavenCentral()
}

asciidoctor {
    sourceDir 'docs'
    resources {
        from ('docs/images') {
            include 'riot.svg'
            include 'architecture.png'
            include 'mapping.png'
            include 'favicon.svg'
        }
        from("riot-file/src/test/resources/files") {
            include '*.*'
        }
    }
}

gitPublish {
    repoUri = 'git@github.com:redis-developer/riot.git'
    referenceRepoUri = 'file:///Users/jruaux/git/riot/'
    branch = 'gh-pages'
    contents {
        from 'build/docs/asciidoc'
    }
}

def isNonStable = { String version ->
    def nonStableKeyword = ['PREVIEW'].any { it -> version.toUpperCase().contains(it) }
    def stableKeyword = ['RELEASE', 'FINAL', 'GA', 'JRE8'].any { it -> version.toUpperCase().contains(it) }
    def regex = /^[0-9,.v-]+([.-]r)?$/
    return nonStableKeyword || (!stableKeyword && !(version ==~ regex))
}

tasks.named("dependencyUpdates").configure {
    rejectVersionIf {
        isNonStable(it.candidate.version) && !isNonStable(it.currentVersion)
    }
}

jreleaser {
    release {
        github {
            owner = 'redis-developer'
            overwrite = true
        }
    }
    packagers {
        brew {
            active = 'RELEASE'
        }
    }
}

gitPublishPush.dependsOn asciidoctor